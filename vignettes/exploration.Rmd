---
title: "Exploration using FinancialModelingR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploration using FinancialModelingR package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Initialization

`FinancialModelingR` package contains several data sets corresponding to commodities, especially soybeans. These data sets are publicly available and are refreshed in different frequencies. The following data sets will be used as examples to show the usage of `FinancialModelingR` for exploring the effects of data sets of different granularities on the daily commodity/stock price:

- Soybean crop progress
- Soybean weekly exports
- Soybean WASDE reports

Functions used for reading and preprocessing these data sets has also been provided in `FinancialModelingR` package. These functions are not discussed in this vignette.

## Loading Crop Progress from FinancialModelingR

```{r warning=F, message=F}
library(FinancialModelingR)
data("soybeanCropProgressUSA2019", package = "FinancialModelingR")
soybeanCropProgress2019$WEEK.ENDING <-
  as.Date(soybeanCropProgress2019$WEEK.ENDING, "%Y-%m-%d")
```

## Loading Private Data

Private data sets used:

- Soybean July 2020 contract prices
- Tweets related to China, soybeans and farmers from \@realdonaldtrump Twitter handle

### Price Data

```{r fig.width=7, fig.height=4, warning=F, message=F}
library(png)
library(grid)
img <- readPNG("private_data/july2020.PNG")
grid.raster(img)
```

This module can be used to read contracts price from a given xlsx file that contains daily open, close, low and high prices of contracts. The structure of the file is as shown above. The function `read_price` can be used to read the file and create columns with change in price. It can also be used to subset the price data by start date and to rename the price columns by appending a given prefix.

```{r fig.width = 7, fig.height = 4}
contractsForJuly2020 <- read_price(
  in_file = "private_data/ActiveSoybeanContractsforJuly2020.xlsx", delta_price = T,
  add_delta = T, subset = T, subset_min_date = "2017-01-01",
  rename_price_columns = T, rename_prefix = "july_2020_", skip_lines = 3)
contractsForJuly2020$Date <- as.Date(contractsForJuly2020$Date, "%Y-%m-%d")
print(head(contractsForJuly2020))
```

### Tweets

```{r fig.width=7, fig.height=4, warning=F, message=F}
img <- readPNG("private_data/realdonaldtrump.PNG")
grid.raster(img)
```

This section uses document term matrix (DTM) created from Excel file containing tweets. The DTM is aggregated in daily level. This module merges the DTM with price to prepare for plotting.

```{r}
# DTM = document term matrix
tweet_dtm_df <- readRDS("private_data/text_features.Rds")
print(head(tweet_dtm_df))
price_tweet_dtm_df <- merge(tweet_dtm_df,
                            contractsForJuly2020[, c("Date", "july_2020_Close")],
                            by.x = "created_at", by.y = "Date")
```

# Plotting

## Daily Data

### Soybean Tweets Example

```{r fig.width = 7, fig.height = 4}
create_corr_plot(independent_var_names = NULL,
                 dependent_var_names = "july_2020_Close",
                 df = price_tweet_dtm_df,
                 remove_cols = c("amp", "get", "want", "many", "will", "just",
                                 "want", "can", "realdonaldtrump", "created_at",
                                 "made", "going", "must", "make"))

price_tweet_dtm_df$china_jobs <- apply(price_tweet_dtm_df[, -1], 1, function(row) {
  as.integer((row["china"] * row["jobs"]) != 0)
})
create_corr_plot(independent_var_names = c("china", "trade", "money",
                                           "deal", "tariffs",
                                           "economy", "currency", "china_jobs"),
                 dependent_var_names = "july_2020_Close",
                 df = price_tweet_dtm_df)
```

## Weekly Data

### Soybean Crop Progress Example

```{r fig.width = 7, fig.height = 4, warning = F}
plot_price_vs_weekly_series(df1_progress = soybeanCropProgress2019,
                            df2_contracts = contractsForJuly2020) +
  labs(title = "Crop_progress_19 vs March Contract price")
```

### Soybean Exports Example

```{r fig.width = 7, fig.height = 4}
library(dplyr)
data("soybeanExports", package = "FinancialModelingR")
competitors <- c("ARGENTINA", "BRAZIL")
df_total_export <- soybeanExports %>% group_by(Country) %>%
  summarize(Total_Export = sum(Weekly_Exports, na.rm = T))
top_countries <- head(x = df_total_export$Country[
  order(df_total_export$Total_Export, decreasing = TRUE)], n = 10)
selected_countries <- c(competitors, top_countries)
df_top_export <- soybeanExports[sapply(
  soybeanExports$Country, function(country) country %in% selected_countries), ]
df_top_export <- inner_join(contractsForJuly2020, df_top_export, by = "Date")
ind_col <- c("Weekly_Exports", "CMY_Outstanding_Sales", "CMY_Gross_New_Sales",
             "CMY_Net_Sales" ,"CMY_Total_Commitment")
corr_mat_weekly <- create_corr_plot(
  independent_var_names = ind_col,
  dependent_var_names = colnames(df_top_export)[
    grep("Close",colnames(df_top_export))],
  df = df_top_export,
  selected_countries = selected_countries,
  country_var = "Country",
  remove_countries = c("GRAND TOTAL", "KNOWN"))
```

## Monthly Data

### WASDE Example

```{r fig.width=7, fig.height=4}
data("soybeanCombinedWASDE")
soybeanWASDE_clean <- clean_wasde(combined_data = soybeanCombinedWASDE)
plot_monthly_data(soybeanWASDE_clean)
```
